---
- name: AWX Playbook - Script İndirme ve Çalıştırma (PVC Kullanımı)
  hosts: localhost
  gather_facts: no
  vars:
    input1: "{{ input1 | default('Default Input 1') }}"
    input2: "{{ input2 | default('Default Input 2') }}"

  tasks:
    - name: GitHub'dan scripti çek (`sh` içinde çalıştır, kalıcı volume içine kaydet)
      shell: "/bin/sh -c 'curl -o /data/awx/projects/awx_script.sh https://raw.githubusercontent.com/testv1c/awxscript/main/awx_script.sh'"
      args:
        executable: /bin/sh

    - name: Script dosyasının izinlerini değiştir
      file:
        path: /data/awx/projects/awx_script.sh
        mode: '0755'

    - name: İndirilen scripti kontrol et
      stat:
        path: /data/awx/projects/awx_script.sh
      register: script_status

    - name: Script dosyasının var olup olmadığını göster
      debug:
        msg: "Script mevcut mu? {{ script_status.stat.exists }}"

    - name: Dışarıdan scripti parametreler ile çalıştır (PVC içinden)
      shell: "/bin/bash /data/awx/projects/awx_script.sh '{{ input1 }}' '{{ input2 }}'"
      register: script_output
      when: script_status.stat.exists

    - name: Script çıktısını göster
      debug:
        msg: "{{ script_output.stdout }}"

    - name: Kalıcı volume içindeki dosyanın içeriğini oku
      command: cat /data/awx/projects/script_output.txt
      register: file_output

    - name: Dosya içeriğini ekrana yazdır
      debug:
        msg: "{{ file_output.stdout }}"
